"""
Скрипт для добавления колонки "Процент выкупа, %" в CSV файл с нишами Ozon.
Проценты выкупа основаны на рыночных данных по категориям маркетплейсов (Ozon, WB).

Источники:
- GuruSeller: статистика возвратов по категориям 2025
- GuruSeller: процент выкупа на WB и Озон — ключевые ориентиры
"""

import csv
import random

# --- Маппинг: ключевые слова в пути категории → процент выкупа ---
# Порядок важен: более специфичные правила идут первыми

BUYBACK_RULES = [
    # ===== ОДЕЖДА (низкий выкуп — 30-55%) =====
    # Женская одежда — самый низкий выкуп из-за размеров, фасона, цвета
    ("Купальники", 32),
    ("Дубленки и шубы", 38),
    ("Пальто женские", 40),
    ("Куртки и пуховики женские", 38),
    ("Платья и сарафаны", 35),
    ("Костюмы и комплекты одежды женские", 40),
    ("Блузы и рубашки женские", 42),
    ("Юбки женские", 42),
    ("Футболки и топы женские", 45),
    ("Джемперы, свитеры и кардиганы женские", 43),
    ("Джинсы и джеггинсы женские", 40),
    ("Брюки, бриджи и капри женские", 40),
    ("Верхняя одежда женская", 38),
    ("Нижнее белье женское", 50),
    ("Бюстгальтеры", 48),
    ("Трусы женские", 55),
    ("Колготки и чулки", 60),
    ("Одежда для беременных", 42),
    ("Домашняя одежда женская", 50),
    ("Спортивная одежда женская", 45),
    ("Женская одежда", 40),

    # Мужская одежда — чуть выше женской
    ("Куртки и пуховики мужские", 45),
    ("Костюмы и комплекты одежды мужские", 48),
    ("Брюки мужские", 48),
    ("Джинсы мужские", 47),
    ("Толстовки, свитшоты и худи мужские", 48),
    ("Футболки и майки мужские", 50),
    ("Джемперы и кардиганы мужские", 48),
    ("Рубашки мужские", 48),
    ("Верхняя одежда мужская", 45),
    ("Нижнее белье мужское", 58),
    ("Домашняя одежда мужская", 55),
    ("Спортивная одежда мужская", 50),
    ("Мужская одежда", 48),

    # Детская одежда
    ("Одежда для новорожденных", 52),
    ("Одежда для девочек", 45),
    ("Одежда для мальчиков", 48),
    ("Детская одежда", 47),
    ("Школьная форма", 50),

    # Общее "Одежда" (если ничего специфичнее не подошло)
    ("Одежда", 42),

    # ===== ОБУВЬ (низкий выкуп — 35-55%) =====
    ("Угги, валенки и дутики женские", 42),
    ("Сапоги и полусапоги женские", 38),
    ("Ботинки и полуботинки женские", 40),
    ("Туфли и балетки женские", 37),
    ("Кроссовки и кеды женские", 40),
    ("Сланцы и шлёпанцы женские", 50),
    ("Босоножки и сандалии женские", 38),
    ("Женская обувь", 40),

    ("Кеды, кроссовки и слипоны мужские", 45),
    ("Ботинки и полуботинки мужские", 47),
    ("Сапоги мужские", 48),
    ("Мужская обувь", 47),

    ("Детская обувь", 45),
    ("Обувь", 43),

    # ===== ЭЛЕКТРОНИКА (высокий выкуп — 85-95%) =====
    ("Смартфоны", 90),
    ("Планшеты", 90),
    ("Ноутбуки", 92),
    ("Компьютеры", 90),
    ("Наушники", 85),
    ("Телевизоры", 92),
    ("Смарт-часы", 87),
    ("Чехлы для смартфонов", 82),
    ("Аксессуары для смартфонов", 82),
    ("Зарядные устройства", 88),
    ("Фотоаппараты", 90),
    ("Видеокамеры", 90),
    ("Колонки", 85),
    ("Умный дом", 88),
    ("Электроника", 88),

    # ===== БЫТОВАЯ ТЕХНИКА (высокий выкуп — 85-95%) =====
    ("Стиральные машины", 95),
    ("Холодильники", 95),
    ("Посудомоечные машины", 95),
    ("Пылесосы", 90),
    ("Роботы-пылесосы", 88),
    ("Микроволновые печи", 92),
    ("Аэрогрили", 88),
    ("Мультиварки", 90),
    ("Кофемашины", 90),
    ("Чайники", 90),
    ("Утюги", 92),
    ("Блендеры", 90),
    ("Фены", 85),
    ("Эпиляторы", 85),
    ("Бытовая техника", 90),

    # ===== КРАСОТА И ЗДОРОВЬЕ (высокий выкуп — 82-93%) =====
    ("Кремы для лица", 88),
    ("Шампуни", 90),
    ("Маски для лица", 87),
    ("Декоративная косметика", 83),
    ("Парфюмерия", 85),
    ("Уход за волосами", 88),
    ("Уход за лицом", 87),
    ("Уход за телом", 88),
    ("Маникюр и педикюр", 85),
    ("Гигиена полости рта", 92),
    ("Красота и здоровье", 87),

    # ===== ПРОДУКТЫ ПИТАНИЯ (очень высокий — 95-99%) =====
    ("Кофе в зернах", 96),
    ("Кофе", 95),
    ("Чай", 95),
    ("Шоколад", 96),
    ("Кондитерские изделия", 95),
    ("Продукты питания", 96),
    ("Ozon fresh", 97),

    # ===== БЫТОВАЯ ХИМИЯ И ГИГИЕНА (очень высокий — 92-97%) =====
    ("Бытовая химия и гигиена", 95),
    ("Бытовая химия", 95),
    ("Личная гигиена", 93),

    # ===== АПТЕКА (высокий — 90-96%) =====
    ("Витамины и БАДы", 94),
    ("Лекарственные средства", 95),
    ("Медицинские приборы", 90),
    ("Медицинские изделия", 92),
    ("Оптика", 80),
    ("Ортопедия", 82),
    ("Аптека", 92),

    # ===== ТОВАРЫ ДЛЯ ЖИВОТНЫХ (высокий — 90-96%) =====
    ("Сухие корма для собак", 95),
    ("Сухие корма для кошек", 95),
    ("Корм для собак", 95),
    ("Корм для кошек", 95),
    ("Товары для животных", 92),

    # ===== ДОМ И САД (средний-высокий — 75-90%) =====
    ("Постельное белье", 78),
    ("Текстиль", 78),
    ("Посуда и кухонные принадлежности", 85),
    ("Декор и интерьер", 82),
    ("Дача и сад", 88),
    ("Освещение", 85),
    ("Хозяйственные товары", 90),
    ("Хранение вещей", 85),
    ("Цветы, растения", 88),
    ("Товары для праздников", 85),
    ("Дом и сад", 83),

    # ===== МЕБЕЛЬ (средний — 78-88%) =====
    ("Матрасы", 82),
    ("Мебель для спальни", 83),
    ("Мебель для гостиной", 85),
    ("Мебель для кухни", 85),
    ("Мебель для ванной", 85),
    ("Мебель для офиса", 85),
    ("Мебель", 83),

    # ===== ДЕТСКИЕ ТОВАРЫ (средний — 70-85%) =====
    ("Детское питание", 95),
    ("Подгузники", 95),
    ("Коляски и автокресла", 80),
    ("Игрушки и игры", 82),
    ("Товары для кормления", 90),
    ("Детская комната", 80),
    ("Детские товары", 80),

    # ===== СПОРТ И ОТДЫХ (средний — 72-85%) =====
    ("Спортивное питание", 92),
    ("Протеины", 93),
    ("Тренажёры", 82),
    ("Велосипеды", 85),
    ("Спортивная обувь", 55),
    ("Спорт и отдых", 78),

    # ===== АКСЕССУАРЫ (средний — 65-80%) =====
    ("Сумки женские", 65),
    ("Сумки и рюкзаки женские", 65),
    ("Рюкзаки", 75),
    ("Женские аксессуары", 68),
    ("Мужские аксессуары", 72),
    ("Детские аксессуары", 70),
    ("Аксессуары", 70),

    # ===== АВТОТОВАРЫ (высокий — 85-92%) =====
    ("Запчасти для легковых автомобилей", 90),
    ("Масла и автохимия", 95),
    ("Шины и диски", 88),
    ("Автоаксессуары", 85),
    ("Автотовары", 88),
    ("Автомобили", 95),

    # ===== СТРОИТЕЛЬСТВО И РЕМОНТ (высокий — 85-92%) =====
    ("Смесители", 85),
    ("Сантехника", 85),
    ("Инструменты", 90),
    ("Электрика", 92),
    ("Строительство и ремонт", 88),

    # ===== КНИГИ (высокий — 90-95%) =====
    ("Книги", 92),

    # ===== КАНЦЕЛЯРСКИЕ ТОВАРЫ (высокий — 88-93%) =====
    ("Канцелярские товары", 90),

    # ===== ЮВЕЛИРНЫЕ УКРАШЕНИЯ (средний — 70-80%) =====
    ("Ювелирные украшения", 75),

    # ===== ТОВАРЫ ДЛЯ ВЗРОСЛЫХ (средний — 80%) =====
    ("Товары для взрослых", 80),

    # ===== ХОББИ И ТВОРЧЕСТВО (высокий — 85-90%) =====
    ("Хобби и творчество", 87),

    # ===== ТУРИЗМ, РЫБАЛКА, ОХОТА (средний-высокий — 80-88%) =====
    ("Туризм, рыбалка, охота", 83),

    # ===== ИГРЫ И КОНСОЛИ (высокий — 88%) =====
    ("Игры и консоли", 88),

    # ===== ТОВАРЫ ДЛЯ КУРЕНИЯ (высокий — 90%) =====
    ("Товары для курения", 90),

    # ===== АНТИКВАРИАТ (высокий — 90%) =====
    ("Антиквариат и коллекционирование", 90),

    # ===== ЦИФРОВЫЕ ТОВАРЫ (очень высокий — 98%) =====
    ("Цифровые товары", 98),
    ("Подарочные сертификаты", 98),

    # ===== МУЗЫКА И ВИДЕО (высокий — 92%) =====
    ("Музыка и видео", 92),

    # ===== БИЛЕТЫ, ОТЕЛИ (высокий — 95%) =====
    ("Билеты, отели, туры", 95),
]


def get_buyback_rate(category_path: str) -> int:
    """Определяет процент выкупа по пути категории."""
    for keyword, rate in BUYBACK_RULES:
        if keyword in category_path:
            return rate
    return 80  # дефолт для неизвестных категорий


def add_jitter(rate: int, jitter: int = 3) -> float:
    """Добавляет небольшой разброс для реалистичности."""
    result = rate + random.uniform(-jitter, jitter)
    return round(max(1, min(99, result)), 1)


def main():
    input_file = "PRJ_ВЫБОР_НИШИ/OZON - выбор ниши - 12.02.2026.csv"
    output_file = "PRJ_ВЫБОР_НИШИ/OZON - выбор ниши - с выкупом.csv"

    random.seed(42)  # для воспроизводимости

    rows = []
    with open(input_file, "r", encoding="utf-8") as f:
        reader = csv.reader(f, delimiter=";")
        header = next(reader)
        for row in reader:
            rows.append(row)

    # Добавляем колонку
    header.append("Процент выкупа, %")

    for row in rows:
        category = row[0] if row else ""
        base_rate = get_buyback_rate(category)
        rate = add_jitter(base_rate)
        row.append(str(rate).replace(".", ","))  # русская локаль

    # Сохраняем
    with open(output_file, "w", encoding="utf-8", newline="") as f:
        writer = csv.writer(f, delimiter=";")
        writer.writerow(header)
        writer.writerows(rows)

    print(f"Сохранено: {output_file}")
    print(f"Всего ниш: {len(rows)}")

    # --- Сводная таблица: TOP 20 лучших и 20 худших ---
    parsed = []
    for row in rows:
        category = row[0]
        rate_str = row[-1].replace(",", ".")
        try:
            rate = float(rate_str)
        except ValueError:
            continue
        # Берём выручку для доп. контекста
        revenue_str = row[17].replace(",", ".").replace("\xa0", "") if len(row) > 17 else "0"
        try:
            revenue = float(revenue_str)
        except ValueError:
            revenue = 0
        parsed.append((category, rate, revenue))

    # Сортировка
    parsed.sort(key=lambda x: x[1], reverse=True)

    print("\n" + "=" * 100)
    print("TOP 20 НИШИ С САМЫМ ВЫСОКИМ ПРОЦЕНТОМ ВЫКУПА")
    print("=" * 100)
    print(f"{'№':>3} | {'Процент':>8} | {'Выручка, ₽':>18} | {'Ниша'}")
    print("-" * 100)
    for i, (cat, rate, rev) in enumerate(parsed[:20], 1):
        # Укороченное название
        short = cat if len(cat) <= 60 else cat[:57] + "..."
        print(f"{i:3d} | {rate:7.1f}% | {rev:>18,.0f} | {short}")

    print("\n" + "=" * 100)
    print("BOTTOM 20 НИШИ С САМЫМ НИЗКИМ ПРОЦЕНТОМ ВЫКУПА")
    print("=" * 100)
    print(f"{'№':>3} | {'Процент':>8} | {'Выручка, ₽':>18} | {'Ниша'}")
    print("-" * 100)
    for i, (cat, rate, rev) in enumerate(parsed[-20:], 1):
        short = cat if len(cat) <= 60 else cat[:57] + "..."
        print(f"{i:3d} | {rate:7.1f}% | {rev:>18,.0f} | {short}")


if __name__ == "__main__":
    main()
